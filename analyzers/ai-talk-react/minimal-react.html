<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Talk - Minimal React Version</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #272822;
            color: #f8f8f2;
            margin: 0;
            padding: 20px;
        }

        .ai-talk-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .chat-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #a6e22e;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px #a6e22e;
        }

        .chat-subtitle {
            font-size: 1.2rem;
            color: #75715e;
            margin-bottom: 2rem;
        }

        .chat-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .chat-sidebar {
            background: rgba(39, 40, 34, 0.8);
            border: 2px solid #49483e;
            border-radius: 15px;
            padding: 1.5rem;
        }

        .api-config h3 {
            color: #a6e22e;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .api-input-group {
            margin-bottom: 1rem;
        }

        .api-label {
            display: block;
            color: #f8f8f2;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .api-input {
            width: 100%;
            padding: 0.8rem;
            background: #272822;
            border: 2px solid #49483e;
            border-radius: 8px;
            color: #f8f8f2;
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .api-input:focus {
            border-color: #a6e22e;
            outline: none;
        }

        .api-save-btn {
            width: 100%;
            background: linear-gradient(45deg, #a6e22e, #66d9ef);
            color: #272822;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px #a6e22e;
        }

        .chat-stats {
            background: #272822;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #75715e;
        }

        .stat-value {
            color: #a6e22e;
            font-weight: bold;
        }

        .clear-chat-btn {
            width: 100%;
            background: linear-gradient(45deg, #f92672, #fd971f);
            color: #272822;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 38, 114, 0.3);
        }

        .chat-main {
            background: rgba(39, 40, 34, 0.8);
            border: 2px solid #49483e;
            border-radius: 15px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #272822;
            border-radius: 10px;
            border: 1px solid #49483e;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.user {
            background: linear-gradient(135deg, #a6e22e, #66d9ef);
            color: #272822;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: rgba(39, 40, 34, 0.8);
            border: 1px solid #49483e;
            color: #f8f8f2;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .typing-indicator {
            padding: 1rem;
            color: #75715e;
            font-style: italic;
        }

        .error-message {
            background: linear-gradient(135deg, #f92672, #fd971f);
            color: #272822;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chat-input-area {
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            background: #272822;
            border: 2px solid #49483e;
            border-radius: 10px;
            color: #f8f8f2;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 50px;
            box-sizing: border-box;
        }

        .chat-input:focus {
            border-color: #a6e22e;
            outline: none;
        }

        .send-btn {
            background: linear-gradient(45deg, #a6e22e, #66d9ef);
            color: #272822;
            padding: 0 2rem;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px #a6e22e;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 1024px) {
            .chat-layout {
                grid-template-columns: 1fr;
            }

            .chat-sidebar {
                order: 2;
            }

            .chat-main {
                order: 1;
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .ai-talk-container {
                padding: 1rem;
            }

            .chat-title {
                font-size: 2rem;
            }

            .chat-input-area {
                flex-direction: column;
            }

            .send-btn {
                width: 100%;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // React Component
        function App() {
            const [messages, setMessages] = React.useState([
                {
                    id: '1',
                    type: 'ai',
                    content: "Hello! I'm Qwen, your AI assistant. How can I help you today? Feel free to ask me questions about programming, mathematics, creative ideas, or anything else you're curious about!",
                    timestamp: new Date()
                }
            ]);

            const [apiConfig, setApiConfig] = React.useState({
                key: localStorage.getItem('qwen-api-config-key') || '',
                endpoint: localStorage.getItem('qwen-api-config-endpoint') || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'
            });

            const [chatStats, setChatStats] = React.useState({
                messages: 1,
                sessionTime: '00:00',
                status: 'Ready'
            });

            const [currentMessage, setCurrentMessage] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [error, setError] = React.useState('');
            const [sessionStart] = React.useState(new Date());

            // Load API config from localStorage on mount
            React.useEffect(() => {
                const saved = localStorage.getItem('qwen-api-config');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setApiConfig(parsed);
                    } catch (error) {
                        console.error('Error parsing saved API config:', error);
                    }
                }
            }, []);

            // Update session time every second
            React.useEffect(() => {
                const interval = setInterval(updateSessionTime, 1000);
                return () => clearInterval(interval);
            }, [sessionStart]);

            const updateSessionTime = () => {
                const elapsed = Math.floor((Date.now() - sessionStart.getTime()) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                setChatStats(prev => ({ ...prev, sessionTime: formattedTime }));
            };

            const saveApiConfig = () => {
                localStorage.setItem('qwen-api-config', JSON.stringify(apiConfig));
                console.log('API configuration saved successfully');
            };

            const handleApiConfigChange = (field, value) => {
                setApiConfig(prev => ({ ...prev, [field]: value }));
            };

            const addMessage = (type, content) => {
                const newMessage = {
                    id: Date.now().toString() + Math.random().toString(36).substring(2, 11),
                    type,
                    content,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, newMessage]);
                setChatStats(prev => ({ ...prev, messages: prev.messages + 1 }));
            };

            const clearChat = () => {
                if (window.confirm('Are you sure you want to clear all messages?')) {
                    setMessages([
                        {
                            id: '1',
                            type: 'ai',
                            content: "Chat cleared! How can I help you today?",
                            timestamp: new Date()
                        }
                    ]);
                    setChatStats(prev => ({ ...prev, messages: 1, status: 'Ready' }));
                    setError('');
                }
            };

            const showError = (message) => {
                setError(message);
                setTimeout(() => setError(''), 5000);
            };

            const callQwenAPI = async (message) => {
                // Try the DashScope native API first
                try {
                    const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.key}`,
                            'X-DashScope-SSE': 'disable'
                        },
                        body: JSON.stringify({
                            model: 'qwen-turbo',
                            input: {
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'You are Qwen, a helpful and intelligent AI assistant. Provide clear, accurate, and engaging responses.'
                                    },
                                    {
                                        role: 'user',
                                        content: message
                                    }
                                ]
                            },
                            parameters: {
                                max_tokens: 1000,
                                temperature: 0.7
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('DashScope API Error:', errorText);
                        throw new Error(`API request failed: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('DashScope API Response:', data);

                    // DashScope native format
                    if (data.output && data.output.text) {
                        return data.output.text;
                    } else {
                        throw new Error('Invalid DashScope response format');
                    }
                } catch (dashScopeError) {
                    console.warn('DashScope API failed, trying OpenAI-compatible endpoint:', dashScopeError);

                    // Fallback to OpenAI-compatible endpoint
                    try {
                        const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiConfig.key}`,
                                'X-DashScope-SSE': 'disable'
                            },
                            body: JSON.stringify({
                                model: 'qwen-turbo',
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'You are Qwen, a helpful and intelligent AI assistant. Provide clear, accurate, and engaging responses.'
                                    },
                                    {
                                        role: 'user',
                                        content: message
                                    }
                                ],
                                max_tokens: 1000,
                                temperature: 0.7,
                                stream: false
                            })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`OpenAI-compatible API failed: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('OpenAI-compatible API Response:', data);

                        // OpenAI-compatible format
                        if (data.choices && data.choices[0] && data.choices[0].message) {
                            return data.choices[0].message.content;
                        } else {
                            throw new Error('Invalid OpenAI-compatible response format');
                        }
                    } catch (openAIError) {
                        console.error('Both API endpoints failed:', openAIError);
                        throw new Error('Failed to connect to Qwen API. Please check your API key and internet connection.');
                    }
                }
            };

            const sendMessage = async () => {
                const message = currentMessage.trim();
                if (!message) return;

                if (!apiConfig.key) {
                    showError('Please configure your Qwen API key first!');
                    return;
                }

                // Add user message
                addMessage('user', message);
                setCurrentMessage('');

                // Show typing indicator
                setIsTyping(true);
                setChatStats(prev => ({ ...prev, status: 'Thinking...' }));

                try {
                    const response = await callQwenAPI(message);
                    addMessage('ai', response);
                    setChatStats(prev => ({ ...prev, status: 'Ready' }));
                } catch (error) {
                    console.error('API Error:', error);
                    showError('Failed to get response from Qwen API. Please check your API key and try again.');
                    setChatStats(prev => ({ ...prev, status: 'Error' }));
                } finally {
                    setIsTyping(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="ai-talk-container">
                    <div className="chat-header">
                        <h1 className="chat-title">AI Talk - Qwen Assistant</h1>
                        <p className="chat-subtitle">
                            Have intelligent conversations with Qwen AI. Ask questions, get coding help, and explore creative ideas.
                        </p>
                    </div>

                    <div className="chat-layout">
                        {/* Sidebar */}
                        <div className="chat-sidebar">
                            <div className="api-config">
                                <h3><i className="fas fa-key"></i> API Configuration</h3>
                                <div className="api-input-group">
                                    <label className="api-label" htmlFor="api-key">Qwen API Key:</label>
                                    <input
                                        type="password"
                                        id="api-key"
                                        className="api-input"
                                        placeholder="Enter your Qwen API key here..."
                                        value={apiConfig.key}
                                        onChange={(e) => handleApiConfigChange('key', e.target.value)}
                                    />
                                </div>
                                <div className="api-input-group">
                                    <label className="api-label" htmlFor="api-endpoint">API Endpoint:</label>
                                    <input
                                        type="text"
                                        id="api-endpoint"
                                        className="api-input"
                                        placeholder="API endpoint URL"
                                        value={apiConfig.endpoint}
                                        onChange={(e) => handleApiConfigChange('endpoint', e.target.value)}
                                    />
                                </div>
                                <button className="api-save-btn" onClick={saveApiConfig}>
                                    <i className="fas fa-save"></i> Save Configuration
                                </button>
                            </div>

                            <div className="chat-stats">
                                <div className="stat-item">
                                    <span>Messages:</span>
                                    <span className="stat-value">{chatStats.messages}</span>
                                </div>
                                <div className="stat-item">
                                    <span>Session:</span>
                                    <span className="stat-value">{chatStats.sessionTime}</span>
                                </div>
                                <div className="stat-item">
                                    <span>Status:</span>
                                    <span className="stat-value">{chatStats.status}</span>
                                </div>
                            </div>

                            <button className="clear-chat-btn" onClick={clearChat}>
                                <i className="fas fa-trash"></i> Clear Chat
                            </button>
                        </div>

                        {/* Main Chat Area */}
                        <div className="chat-main">
                            <div className="chat-messages">
                                {messages.map((message) => (
                                    <div key={message.id} className={`message ${message.type}`}>
                                        <div className="message-header">
                                            <i className={`fas ${message.type === 'user' ? 'fa-user' : 'fa-robot'}`}></i>
                                            {message.type === 'user' ? 'You' : 'Qwen AI'}
                                        </div>
                                        <div className="message-content">{message.content}</div>
                                    </div>
                                ))}

                                {isTyping && (
                                    <div className="typing-indicator">
                                        <i className="fas fa-circle-notch fa-spin"></i> Qwen is thinking...
                                    </div>
                                )}
                            </div>

                            {error && (
                                <div className="error-message">
                                    ‚ùå {error}
                                </div>
                            )}

                            <div className="chat-input-area">
                                <textarea
                                    className="chat-input"
                                    placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)"
                                    rows={3}
                                    value={currentMessage}
                                    onChange={(e) => setCurrentMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                />
                                <button
                                    className="send-btn"
                                    onClick={sendMessage}
                                    disabled={!currentMessage.trim() || isTyping}
                                >
                                    <i className="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
